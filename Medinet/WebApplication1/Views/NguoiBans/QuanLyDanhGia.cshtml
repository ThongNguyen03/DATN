@model List<WebApplication1.Models.DanhGiaSanPham>
@{
    ViewBag.Title = "Quản lý đánh giá";
    Layout = "~/Views/Shared/_Layout.cshtml";
    int currentPage = ViewBag.CurrentPage;
    int totalPages = ViewBag.TotalPages;
    int totalItems = ViewBag.TotalItems;
    bool hasPreviousPage = ViewBag.HasPreviousPage;
    bool hasNextPage = ViewBag.HasNextPage;
    int pageSize = ViewBag.PageSize;
    double? trungBinhDanhGia = ViewBag.TrungBinhDanhGia;
    var thongKeDanhGia = ViewBag.ThongKeDanhGia as Dictionary<int?, int>;

    // Lấy danh sách phản hồi từ ViewBag
    var phanHoiList = ViewBag.PhanHoiList as List<WebApplication1.Models.PhanHoiDanhGia>;
}

<style>
    /* Custom styles for tabs and sidebar */
    .seller-sidebar {
        background-color: #ffffff; /* White background for seller sidebar */
        border: 1px solid #e9ecef;
    }

        .seller-sidebar .card-header {
            background-color: #f8f9fa; /* Light gray header */
            color: #212529; /* Dark text */
            border-bottom: 1px solid #e9ecef;
        }

        .seller-sidebar .list-group-item {
            background-color: transparent;
            color: #212529; /* Dark text */
            border-color: #e9ecef;
        }

            .seller-sidebar .list-group-item:hover {
                background-color: #f8f9fa;
            }

            .seller-sidebar .list-group-item.active {
                background-color: #007bff;
                border-color: #007bff;
                color: #ffffff; /* White text for active item */
            }

    /* Pagination styling */
    .pagination > li {
        display: inline-block;
        margin-right: 5px;
    }

        .pagination > li > a,
        .pagination > li > span {
            color: #007bff;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            padding: 0.5rem 0.75rem;
        }

    .pagination > .active > a,
    .pagination > .active > span {
        background-color: #007bff;
        border-color: #007bff;
        color: white;
    }

    .pagination > .disabled > a,
    .pagination > .disabled > span {
        color: #6c757d;
        pointer-events: none;
        background-color: #fff;
    }

    /* Đánh giá sao styling */
    .star-rating {
        color: #ffc107; /* Star color */
        font-size: 18px;
    }

    .rating-summary {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .rating-bars .progress {
        height: 8px;
        margin-bottom: 10px;
    }

    .rating-count {
        min-width: 30px;
        text-align: right;
    }

    /* CSS để đảm bảo button search và input cùng kích thước */
    .input-group .input-group-append .btn {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        /* Đảm bảo icon nằm giữa button */
        .input-group .input-group-append .btn i {
            margin: 0;
        }

    /* Styling cho các tab */
    .rating-tabs .nav-link {
        color: #6c757d;
        border: none;
        border-radius: 0;
        padding: 0.5rem 1rem;
        font-weight: 500;
        text-transform: uppercase;
        font-size: 0.9rem;
    }

        .rating-tabs .nav-link.active {
            color: #007bff;
            background-color: transparent;
            border-bottom: 2px solid #007bff;
        }

    /* Styling cho bảng đánh giá */
    #reviewTable {
        border-collapse: collapse;
        box-shadow: 0 2px 3px rgba(0,0,0,0.05);
    }

        #reviewTable th {
            vertical-align: middle;
            font-weight: 600;
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            text-align: center;
        }

        #reviewTable td {
            vertical-align: middle;
            padding: 0.75rem;
            line-height: 1.5;
        }

        /* Thêm màu nền xen kẻ cho bảng */
        #reviewTable tbody tr:nth-of-type(odd) {
            background-color: rgba(0,0,0,0.02);
        }

        /* Style cho hover dòng */
        #reviewTable tbody tr:hover {
            background-color: rgba(0,123,255,0.05);
        }

    /* Nội dung đánh giá */
    .review-content {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Ngày đánh giá */
    .review-date {
        color: #6c757d;
        font-size: 0.9rem;
    }

    /* Reply button */
    .btn-reply {
        color: #28a745;
        border-color: #28a745;
    }

        .btn-reply:hover {
            background-color: #28a745;
            color: white;
        }

    /* Phản hồi styling */
    .seller-reply {
        background-color: #f8f9fa;
        border-left: 3px solid #28a745;
        padding: 10px;
        margin-top: 10px;
        border-radius: 0 4px 4px 0;
    }

    .seller-name {
        font-weight: 600;
        color: #28a745;
    }

    /* Thẻ trạng thái đã trả lời */
    .badge-replied {
        background-color: #17a2b8;
        color: white;
    }

    /* Stars container */
    .stars-container {
        white-space: nowrap;
    }

    /* Thêm CSS mới vào phần <style> */

    /* Styling cho phần đánh giá người dùng */
    .review-box {
        background-color: #ffffff;
        border-radius: 6px;
        padding: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* Styling cho phần phản hồi của người bán */
    .seller-reply-row {
        background-color: #f5f9ff !important;
    }

    .seller-reply-container {
        margin: 0 0 15px 20px;
        background-color: #f8f9fa;
        border-left: 3px solid #28a745;
        border-radius: 0 6px 6px 0;
        padding: 0;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .seller-reply-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background-color: #f0f8f3;
        border-radius: 0 6px 0 0;
        border-bottom: 1px solid #e0e9e5;
    }

    .seller-name {
        font-weight: 600;
        color: #28a745;
    }

    .seller-reply-content {
        padding: 15px;
    }

    .reply-text {
        margin-bottom: 8px;
    }

    .reply-date {
        text-align: right;
        font-size: 0.85rem;
        color: #6c757d;
    }

    .toggle-reply {
        padding: 0.2rem 0.5rem;
    }

        .toggle-reply:hover {
            background-color: #e2e6ea;
        }

    /* Override table styling for reply rows */
    #reviewTable tbody tr.seller-reply-row:hover {
        background-color: #f5f9ff !important;
    }

    #reviewTable tbody tr.seller-reply-row td {
        border-top: none;
        padding-top: 0;
    }


    /* CSS cho các mẫu phản hồi */
    .reply-templates {
        margin-bottom: 15px;
    }

    .reply-category {
        font-weight: 600;
        color: #333;
        padding: 8px 0;
        margin-top: 10px;
        border-bottom: 1px solid #e0e0e0;
    }

    .reply-template-item {
        padding: 10px 15px;
        margin: 5px 0;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        background-color: #f8f9fa;
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

        .reply-template-item:hover {
            background-color: #e9ecef;
            border-color: #ced4da;
            transform: translateY(-2px);
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
        }

        .reply-template-item.selected {
            background-color: #d4edda;
            border-color: #28a745;
            box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25);
        }

        .reply-template-item::before {
            content: "👉";
            position: absolute;
            left: -20px;
            transition: all 0.2s ease;
            opacity: 0;
        }

        .reply-template-item:hover::before {
            left: 0;
            opacity: 1;
        }

    /* Tùy chỉnh màu sắc theo loại đánh giá */
    .reply-category + .reply-template-item {
        /* Đánh giá tích cực */
        border-left: 3px solid #28a745;
    }

        .reply-category + .reply-template-item + .reply-template-item {
            /* Đánh giá tích cực */
            border-left: 3px solid #28a745;
        }

            .reply-category + .reply-template-item + .reply-template-item + .reply-template-item {
                /* Đánh giá tích cực */
                border-left: 3px solid #28a745;
            }

    /* Đánh giá trung bình */
    .reply-category:nth-of-type(2) + .reply-template-item {
        border-left: 3px solid #ffc107;
    }

        .reply-category:nth-of-type(2) + .reply-template-item + .reply-template-item {
            border-left: 3px solid #ffc107;
        }

    /* Đánh giá tiêu cực */
    .reply-category:nth-of-type(3) + .reply-template-item {
        border-left: 3px solid #dc3545;
    }

        .reply-category:nth-of-type(3) + .reply-template-item + .reply-template-item {
            border-left: 3px solid #dc3545;
        }

            .reply-category:nth-of-type(3) + .reply-template-item + .reply-template-item + .reply-template-item {
                border-left: 3px solid #dc3545;
            }
</style>

<div class="container mt-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <div class="card seller-sidebar">
                <div class="card-header text-black">
                    <h5 class="mb-0">Trang người bán</h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="@Url.Action("EditSellerProfile", "NguoiDungs")" class="list-group-item list-group-item-action">
                        <i class="fas fa-store mr-2"></i> Thông tin cửa hàng
                    </a>
                    <a href="@Url.Action("QuanLySanPham", "NguoiBans", new { id = ViewBag.MaNguoiBan })" class="list-group-item list-group-item-action">
                        <i class="fas fa-box mr-2"></i> Sản phẩm
                    </a>
                    <a href="@Url.Action("DonHangNguoiMua", "DonHang")" class="list-group-item list-group-item-action">
                        <i class="fas fa-shopping-cart mr-2"></i> Đơn hàng
                    </a>
                    <a href="@Url.Action("GiaoDichNguoiBan", "GiaoDich")" class="list-group-item list-group-item-action">
                        <i class="fas fa-exchange-alt mr-2"></i> Lịch sử giao dịch
                    </a>
                    <a href="@Url.Action("ViNguoiBan", "GiaoDich")" class="list-group-item list-group-item-action">
                        <i class="fas fa-wallet mr-2"></i> Ví của tôi
                    </a>
                    <a href="@Url.Action("QuanLyDanhGia", "NguoiBans", new { id = ViewBag.MaNguoiBan })" class="list-group-item list-group-item-action active">
                        <i class="fas fa-star mr-2"></i> Đánh giá
                    </a>
                    <a href="@Url.Action("QuanLyTaiKhoan", "NguoiBans", new { id = ViewBag.MaNguoiBan })" class="list-group-item list-group-item-action">
                        <i class="fas fa-chart-line mr-2"></i> Thống kê
                    </a>
                    <a href="@Url.Action("DangXuat", "DangNhap")" class="list-group-item list-group-item-action text-danger">
                        <i class="fas fa-sign-out-alt mr-2"></i> Đăng xuất
                    </a>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Quản lý đánh giá - @ViewBag.TenCuaHang</h5>
                </div>
                <div class="card-body">
                    <!-- Tổng quan đánh giá -->
                    <div class="rating-summary mb-4">
                        <div class="row">
                            <div class="col-md-3 text-center">
                                <h2 class="mb-0">@(trungBinhDanhGia.HasValue ? Math.Round(trungBinhDanhGia.Value, 1).ToString("0.0") : "0.0")</h2>
                                <div class="star-rating">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        if (trungBinhDanhGia.HasValue && i <= Math.Round(trungBinhDanhGia.Value))
                                        {
                                            <i class="fas fa-star"></i>
                                        }
                                        else if (trungBinhDanhGia.HasValue && i - 0.5 <= Math.Round(trungBinhDanhGia.Value, 1))
                                        {
                                            <i class="fas fa-star-half-alt"></i>
                                        }
                                        else
                                        {
                                            <i class="far fa-star"></i>
                                        }
                                    }
                                </div>
                                <p class="text-muted mt-2">@totalItems đánh giá</p>
                            </div>
                            <div class="col-md-9">
                                <div class="rating-bars">
                                    @for (int i = 5; i >= 1; i--)
                                    {
                                        int count = thongKeDanhGia != null && thongKeDanhGia.ContainsKey(i) ? thongKeDanhGia[i] : 0;
                                        double percent = totalItems > 0 ? (double)count / totalItems * 100 : 0;
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="mr-2">@i <i class="fas fa-star text-warning"></i></div>
                                            <div class="progress flex-grow-1">
                                                <div class="progress-bar bg-warning" role="progressbar" style="width: @percent%" aria-valuenow="@percent" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                            <div class="rating-count ml-2">@count</div>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Phần tabs -->
                    <ul class="nav nav-tabs rating-tabs mb-3" id="ratingTabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link @(string.IsNullOrEmpty(ViewBag.StatusFilter) || (ViewBag.StatusFilter != "replied" && ViewBag.StatusFilter != "waiting") ? "active" : "")" id="all-tab" href="@Url.Action("QuanLyDanhGia", "NguoiBans", new { id = ViewBag.MaNguoiBan })" role="tab">
                                Tất cả
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link @(ViewBag.StatusFilter == "replied" ? "active" : "")" id="replied-tab" href="@Url.Action("QuanLyDanhGia", "NguoiBans", new { id = ViewBag.MaNguoiBan, statusFilter = "replied" })" role="tab">
                                Đã trả lời
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link @(ViewBag.StatusFilter == "waiting" ? "active" : "")" id="waiting-tab" href="@Url.Action("QuanLyDanhGia", "NguoiBans", new { id = ViewBag.MaNguoiBan, statusFilter = "waiting" })" role="tab">
                                Chờ trả lời
                            </a>
                        </li>
                    </ul>
                    <!-- Phần tìm kiếm và lọc -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <form id="searchForm" method="get" action="@Url.Action("QuanLyDanhGia", "NguoiBans")">
                                <input type="hidden" name="id" value="@ViewBag.MaNguoiBan" />
                                <input type="hidden" name="page" value="1" />
                                <input type="hidden" name="statusFilter" id="hiddenStatusFilter" value="@ViewBag.StatusFilter" />
                                <input type="hidden" name="sortOrder" id="hiddenSortOrder" value="@ViewBag.SortOrder" />

                                <div class="input-group">
                                    <input type="text" id="searchInput" name="searchTerm" class="form-control" placeholder="Tìm kiếm đánh giá..." value="@ViewBag.SearchTerm">
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-secondary" type="submit">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-3">
                            <select id="ratingFilter" class="form-control" onchange="applyFilter()">
                                <option value="">-- Tất cả số sao --</option>
                                <option value="5" @(ViewBag.StatusFilter == "5" ? "selected" : "")>5 sao</option>
                                <option value="4" @(ViewBag.StatusFilter == "4" ? "selected" : "")>4 sao</option>
                                <option value="3" @(ViewBag.StatusFilter == "3" ? "selected" : "")>3 sao</option>
                                <option value="2" @(ViewBag.StatusFilter == "2" ? "selected" : "")>2 sao</option>
                                <option value="1" @(ViewBag.StatusFilter == "1" ? "selected" : "")>1 sao</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select id="sortOrder" class="form-control" onchange="applyFilter()">
                                <option value="newest" @(ViewBag.SortOrder == "newest" ? "selected" : "")>Mới nhất</option>
                                <option value="oldest" @(ViewBag.SortOrder == "oldest" ? "selected" : "")>Cũ nhất</option>
                                <option value="ratingDesc" @(ViewBag.SortOrder == "ratingDesc" ? "selected" : "")>Đánh giá cao nhất</option>
                                <option value="ratingAsc" @(ViewBag.SortOrder == "ratingAsc" ? "selected" : "")>Đánh giá thấp nhất</option>
                                <option value="productAsc" @(ViewBag.SortOrder == "productAsc" ? "selected" : "")>Sản phẩm A-Z</option>
                                <option value="productDesc" @(ViewBag.SortOrder == "productDesc" ? "selected" : "")>Sản phẩm Z-A</option>
                            </select>
                        </div>
                    </div>

                    <!-- Bảng danh sách đánh giá -->
                    <div class="table-responsive">
                        <table class="table table-hover" id="reviewTable">
                            <thead>
                                <tr>
                                    <th width="60">STT</th>
                                    <th>Sản phẩm</th>
                                    <th>Đánh giá</th>
                                    <th width="160">Người mua</th>
                                    <th >Ngày tạo</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model != null && Model.Any())
                                {
                                    int stt = (currentPage - 1) * pageSize + 1;
                                    foreach (var item in Model)
                                    {
                                        var phanHoi = phanHoiList?.FirstOrDefault(p => p.MaDanhGiaSanPham == item.MaDanhGiaSanPham);
                                        bool daPhanHoi = phanHoi != null;

                                        @* Thay đổi cấu trúc hiển thị đánh giá và phản hồi *@
                                        <tr>
                                            <td class="text-center">@stt</td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    @{
                                                        string anhHienThi = Url.Content("~/Content/images/no-image.jpeg");
                                                        if (item.SanPham != null && item.SanPham.AnhSanPhams != null && item.SanPham.AnhSanPhams.Any())
                                                        {
                                                            anhHienThi = item.SanPham.AnhSanPhams.First().DuongDanAnh;
                                                        }
                                                    }
                                                    <img src="@anhHienThi" alt="@item.SanPham?.TenSanPham" class="img-thumbnail mr-2" style="width: 50px; height: 50px; object-fit: cover;">
                                                    <div style="margin-left:12px">
                                                        <a href="@Url.Action("ChiTietDonHangNguoiMua", "DonHang", new { id = item.MaDonHang })" style=" text-decoration: none; color: inherit;">
                                                            @(item.SanPham?.TenSanPham ?? "Không có tên")
                                                        </a>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="review-box">
                                                    <div class="stars-container mb-1">
                                                        @for (int i = 1; i <= 5; i++)
                                                        {
                                                            if (item.DanhGia.HasValue && i <= item.DanhGia.Value)
                                                            {
                                                                <i class="fas fa-star text-warning"></i>
                                                            }
                                                            else
                                                            {
                                                                <i class="far fa-star text-warning"></i>
                                                            }
                                                        }
                                                        @if (daPhanHoi)
                                                        {
                                                            <span class="badge badge-info ml-2">Đã trả lời</span>
                                                        }
                                                    </div>
                                                    <div class="review-content">@item.BinhLuan</div>
                                                </div>
                                            </td>
                                            <td>
                                                <div style="text-align:center">@item.NguoiDung.TenNguoiDung</div>
                                            </td>
                                            <td>
                                                <div class="review-date" style="text-align:center">@item.NgayTao.ToString("dd/MM/yyyy")</div>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm @(daPhanHoi ? "btn-warning" : "btn-info")"
                                                        data-toggle="modal" data-target="#replyModal"
                                                        data-review-id="@item.MaDanhGiaSanPham"
                                                        data-rating="@item.DanhGia"
                                                        data-product="@item.SanPham.TenSanPham"
                                                        data-comment="@item.BinhLuan"
                                                        data-reply="@(daPhanHoi ? phanHoi.NoiDungPhanHoi : "")">
                                                    <i class="fas @(daPhanHoi ? "fa-edit" : "fa-reply")"></i>
                                                    @(daPhanHoi ? "Sửa phản hồi" : "Trả lời")
                                                </button>
                                            </td>
                                        </tr>

                                        if (daPhanHoi)
                                        {
                                            <tr class="seller-reply-row">
                                                <td></td>
                                                <td colspan="5">
                                                    <div class="seller-reply-container">
                                                        <div class="seller-reply-header">
                                                            <span class="seller-name"><i class="fas fa-store mr-1"></i> Phản hồi của Shop:</span>
                                                            <button class="btn btn-sm btn-outline-secondary toggle-reply"
                                                                    data-toggle="collapse"
                                                                    data-target="#sellerReply-@item.MaDanhGiaSanPham">
                                                                <i class="fas fa-chevron-down"></i>
                                                            </button>
                                                        </div>
                                                        <div id="sellerReply-@item.MaDanhGiaSanPham" class="seller-reply-content collapse show">
                                                            <div class="reply-text">@phanHoi.NoiDungPhanHoi</div>
                                                            <div class="reply-date text-muted small">@phanHoi.NgayTao.ToString("dd/MM/yyyy HH:mm")</div>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                        stt++;
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="6" class="text-center py-4">
                                            @if (!string.IsNullOrEmpty(ViewBag.SearchTerm) || !string.IsNullOrEmpty(ViewBag.StatusFilter))
                                            {
                                                <div class="alert alert-info mt-2">
                                                    <i class="fas fa-info-circle mr-2"></i> Không tìm thấy đánh giá nào phù hợp với bộ lọc.
                                                    <a href="@Url.Action("QuanLyDanhGia", "NguoiBans", new { id = ViewBag.MaNguoiBan })" class="alert-link">Xóa bộ lọc</a>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="mt-3">
                                                    <i class="fas fa-star fa-3x text-muted mb-3"></i>
                                                    <p>Chưa có đánh giá nào</p>
                                                </div>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Phân trang - chỉ hiển thị khi có đánh giá -->
                    @if (Model != null && Model.Any() && ViewBag.TotalPages > 1)
                    {
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                <span>Hiển thị @Model.Count() trên tổng số @ViewBag.TotalItems đánh giá</span>
                            </div>
                            <div>
                                <ul class="pagination mb-0">
                                    @if (ViewBag.HasPreviousPage)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" href="@Url.Action("QuanLyDanhGia", "NguoiBans", new { id = ViewBag.MaNguoiBan, page = ViewBag.CurrentPage - 1, searchTerm = ViewBag.SearchTerm, statusFilter = ViewBag.StatusFilter, sortOrder = ViewBag.SortOrder })">
                                                <i class="fas fa-chevron-left"></i>
                                            </a>
                                        </li>
                                    }
                                    else
                                    {
                                        <li class="page-item disabled">
                                            <span class="page-link"><i class="fas fa-chevron-left"></i></span>
                                        </li>
                                    }

                                    @{
                                        const int maxPagesToShow = 5;
                                        int startPage = Math.Max(1, ViewBag.CurrentPage - maxPagesToShow / 2);
                                        int endPage = Math.Min(ViewBag.TotalPages, startPage + maxPagesToShow - 1);

                                        // Điều chỉnh lại startPage nếu cần thiết
                                        if (endPage - startPage + 1 < maxPagesToShow)
                                        {
                                            startPage = Math.Max(1, endPage - maxPagesToShow + 1);
                                        }
                                    }

                                    @for (int i = startPage; i <= endPage; i++)
                                    {
                                        if (i == ViewBag.CurrentPage)
                                        {
                                            <li class="page-item active">
                                                <span class="page-link">@i</span>
                                            </li>
                                        }
                                        else
                                        {
                                            <li class="page-item">
                                                <a class="page-link" href="@Url.Action("QuanLyDanhGia", "NguoiBans", new { id = ViewBag.MaNguoiBan, page = i, searchTerm = ViewBag.SearchTerm, statusFilter = ViewBag.StatusFilter, sortOrder = ViewBag.SortOrder })">@i</a>
                                            </li>
                                        }
                                    }

                                    @if (ViewBag.HasNextPage)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" href="@Url.Action("QuanLyDanhGia", "NguoiBans", new { id = ViewBag.MaNguoiBan, page = ViewBag.CurrentPage + 1, searchTerm = ViewBag.SearchTerm, statusFilter = ViewBag.StatusFilter, sortOrder = ViewBag.SortOrder })">
                                                <i class="fas fa-chevron-right"></i>
                                            </a>
                                        </li>
                                    }
                                    else
                                    {
                                        <li class="page-item disabled">
                                            <span class="page-link"><i class="fas fa-chevron-right"></i></span>
                                        </li>
                                    }
                                </ul>
                            </div>
                        </div>
                    }
                    else if (Model != null && Model.Any())
                    {
                        <div class="mt-3">
                            <span>Hiển thị @Model.Count() trên tổng số @ViewBag.TotalItems đánh giá</span>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal để trả lời đánh giá -->
<div class="modal fade" id="replyModal" tabindex="-1" role="dialog" aria-labelledby="replyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="replyModalLabel">Trả lời đánh giá</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            @using (Html.BeginForm("TraLoiDanhGia", "NguoiBans", FormMethod.Post))
            {
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <input type="hidden" id="maDanhGia" name="maDanhGia" value="" />

                    <div class="form-group">
                        <label>Sản phẩm:</label>
                        <p id="productName" class="font-weight-bold"></p>
                    </div>

                    <div class="form-group">
                        <label>Đánh giá người mua:</label>
                        <div>
                            <div id="reviewRating" class="stars-container mb-2"></div>
                            <p id="reviewComment" class="font-italic"></p>
                        </div>
                    </div>

                    <!-- Mẫu phản hồi nhanh -->
                    <div class="form-group">
                        <label>Chọn mẫu phản hồi nhanh:</label>

                        <p class="text-muted small"><i class="fas fa-info-circle"></i> Nhấp vào một mẫu bên dưới để sử dụng:</p>
                        <div class="reply-templates">
                            <!-- Phản hồi cho đánh giá tích cực -->
                            <div class="reply-category">Đánh giá tích cực (4-5 sao)</div>
                            <div class="reply-template-item" data-template="Cảm ơn quý khách đã đánh giá tích cực về sản phẩm của chúng tôi! Rất vui khi sản phẩm đã đáp ứng được mong đợi của quý khách. Hy vọng sẽ được phục vụ quý khách trong những lần mua sắm tiếp theo!">
                                <strong>Cảm ơn chung:</strong> Lời cảm ơn cho đánh giá tích cực
                            </div>
                            <div class="reply-template-item" data-template="Xin chân thành cảm ơn quý khách đã dành thời gian đánh giá sản phẩm! Chúng tôi rất vui khi biết quý khách hài lòng và sẽ tiếp tục nỗ lực để mang đến những sản phẩm chất lượng nhất. Rất mong được phục vụ quý khách trong tương lai!">
                                <strong>Cảm ơn chi tiết:</strong> Lời cảm ơn chi tiết và cam kết chất lượng
                            </div>
                            <div class="reply-template-item" data-template="Cảm ơn quý khách đã tin tưởng và ủng hộ shop! Nhận được phản hồi tích cực từ quý khách là niềm vui và động lực lớn với chúng tôi. Shop sẽ luôn cố gắng duy trì chất lượng sản phẩm và dịch vụ. Chúc quý khách một ngày tốt lành!">
                                <strong>Cảm ơn đặc biệt:</strong> Lời cảm ơn nhiệt thành
                            </div>

                            <!-- Phản hồi cho đánh giá trung bình -->
                            <div class="reply-category mt-3">Đánh giá trung bình (3 sao)</div>
                            <div class="reply-template-item" data-template="Cảm ơn quý khách đã đánh giá sản phẩm của chúng tôi. Chúng tôi rất tiếc vì chưa thể đáp ứng hoàn toàn kỳ vọng của quý khách. Mọi ý kiến đóng góp đều rất quý báu để chúng tôi cải thiện sản phẩm và dịch vụ. Rất mong được phục vụ quý khách tốt hơn trong lần tới!">
                                <strong>Ghi nhận ý kiến:</strong> Cảm ơn và ghi nhận phản hồi trung bình
                            </div>
                            <div class="reply-template-item" data-template="Xin chân thành cảm ơn phản hồi của quý khách. Chúng tôi luôn nỗ lực cải thiện chất lượng sản phẩm và dịch vụ. Quý khách có thể chia sẻ thêm điều gì chúng tôi có thể cải thiện không? Rất mong nhận được góp ý chi tiết qua tin nhắn để chúng tôi phục vụ tốt hơn.">
                                <strong>Đề nghị góp ý:</strong> Đề nghị khách hàng cung cấp thêm góp ý
                            </div>

                            <!-- Phản hồi cho đánh giá tiêu cực -->
                            <div class="reply-category mt-3">Đánh giá tiêu cực (1-2 sao)</div>
                            <div class="reply-template-item" data-template="Chúng tôi thành thật xin lỗi vì trải nghiệm không tốt của quý khách. Chúng tôi rất mong nhận được thông tin chi tiết về vấn đề quý khách gặp phải để có thể hỗ trợ khắc phục. Quý khách vui lòng liên hệ với chúng tôi qua tin nhắn hoặc hotline để được hỗ trợ nhanh nhất.">
                                <strong>Xin lỗi và đề nghị hỗ trợ:</strong> Xin lỗi và mong muốn hỗ trợ khách hàng
                            </div>
                            <div class="reply-template-item" data-template="Chúng tôi vô cùng tiếc nuối khi sản phẩm chưa đáp ứng được mong đợi của quý khách. Đây là điều chúng tôi không mong muốn và rất mong có cơ hội khắc phục. Quý khách vui lòng liên hệ với chúng tôi để được hỗ trợ đổi/trả hàng hoặc các giải pháp phù hợp khác.">
                                <strong>Đề nghị đổi/trả:</strong> Đề xuất đổi/trả hàng để khắc phục vấn đề
                            </div>
                            <div class="reply-template-item" data-template="Xin chân thành cảm ơn quý khách đã chia sẻ trải nghiệm. Chúng tôi rất tiếc về sự không hài lòng của quý khách và sẽ nghiêm túc rút kinh nghiệm. Chúng tôi đã ghi nhận phản hồi và sẽ cải thiện sản phẩm/dịch vụ. Rất mong có cơ hội được phục vụ quý khách tốt hơn trong tương lai.">
                                <strong>Ghi nhận và cải thiện:</strong> Ghi nhận ý kiến và cam kết cải thiện
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="noiDungTraLoi">Phản hồi của bạn:</label>
                        <textarea id="noiDungTraLoi" name="noiDungTraLoi" class="form-control" rows="5"
                                  placeholder="Nhập phản hồi của bạn về đánh giá này..." required></textarea>
                        <small class="form-text text-muted">
                            Phản hồi của bạn sẽ được hiển thị công khai. Hãy viết một phản hồi chuyên nghiệp để duy trì mối quan hệ tốt với khách hàng.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-info">Gửi phản hồi</button>
                </div>
            }
        </div>
    </div>
</div>
@section Scripts {
    <script>
    // Hiển thị thông báo nếu có
    function showAlert(message, type) {
        var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        var alertHtml = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
            message +
            '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
            '<span aria-hidden="true">&times;</span>' +
            '</button>' +
            '</div>';

        // Thêm thông báo vào đầu card-body
        $('.card-body:first').prepend(alertHtml);

        // Tự động đóng thông báo sau 5 giây
        setTimeout(function() {
            $('.alert').alert('close');
        }, 5000);
    }

    $(document).ready(function() {
        // Kiểm tra và hiển thị thông báo từ TempData
        var successMessage = '@TempData["Success"]';
        var errorMessage = '@TempData["Error"]';

        if (successMessage && successMessage !== '' && successMessage !== '@TempData["Success"]') {
            showAlert(successMessage, 'success');
        }

        if (errorMessage && errorMessage !== '' && errorMessage !== '@TempData["Error"]') {
            showAlert(errorMessage, 'error');
        }

        // Tab navigation
        $('#all-tab, #replied-tab, #waiting-tab').click(function(e) {
            e.preventDefault();
            window.location.href = $(this).attr('href');
        });

        // Xử lý khi chọn mẫu phản hồi nhanh
        $('.reply-template-item').click(function() {
            // Xóa lớp selected khỏi tất cả các mẫu
            $('.reply-template-item').removeClass('selected');

            // Thêm lớp selected vào mẫu được chọn
            $(this).addClass('selected');

            // Lấy nội dung mẫu và đưa vào textarea
            var template = $(this).data('template');
            $('#noiDungTraLoi').val(template);
        });

        // Modal để trả lời đánh giá
        $('#replyModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            var reviewId = button.data('review-id');
            var rating = button.data('rating');
            var product = button.data('product');
            var comment = button.data('comment');
            var reply = button.data('reply');

            var modal = $(this);
            modal.find('#maDanhGia').val(reviewId);
            modal.find('#productName').text(product);

            // Hiển thị số sao
            var ratingHtml = '';
            for (var i = 1; i <= 5; i++) {
                if (i <= rating) {
                    ratingHtml += '<i class="fas fa-star text-warning"></i> ';
                } else {
                    ratingHtml += '<i class="far fa-star text-warning"></i> ';
                }
            }
            modal.find('#reviewRating').html(ratingHtml);

            // Hiển thị nội dung đánh giá
            modal.find('#reviewComment').text(comment);

            // Nếu đã có phản hồi thì điền vào
            modal.find('#noiDungTraLoi').val(reply);

            // Reset các mẫu được chọn
            $('.reply-template-item').removeClass('selected');

            // Hiển thị các mẫu phản hồi phù hợp với số sao
            if (rating >= 4) {
                // Hiển thị nổi bật các mẫu cho đánh giá tích cực
                $('.reply-category').each(function() {
                    if ($(this).text().includes('tích cực')) {
                        $(this).closest('.reply-category').next().next().next().addClass('d-block');
                    }
                });
            } else if (rating == 3) {
                // Hiển thị nổi bật các mẫu cho đánh giá trung bình
                $('.reply-category').each(function() {
                    if ($(this).text().includes('trung bình')) {
                        $(this).closest('.reply-category').next().next().addClass('d-block');
                    }
                });
            } else {
                // Hiển thị nổi bật các mẫu cho đánh giá tiêu cực
                $('.reply-category').each(function() {
                    if ($(this).text().includes('tiêu cực')) {
                        $(this).closest('.reply-category').next().next().next().addClass('d-block');
                    }
                });
            }

            // Thay đổi tiêu đề modal nếu đã có phản hồi
            if (reply) {
                modal.find('#replyModalLabel').text('Chỉnh sửa phản hồi');
                modal.find('button[type="submit"]').text('Cập nhật phản hồi');
            } else {
                modal.find('#replyModalLabel').text('Trả lời đánh giá');
                modal.find('button[type="submit"]').text('Gửi phản hồi');
            }
        });

        // Khi đóng modal, reset lại các mẫu được chọn
        $('#replyModal').on('hidden.bs.modal', function() {
            $('.reply-template-item').removeClass('selected');
        });

        // Thêm vào phần $(document).ready(function() {...}) 
        // Xử lý sự kiện khi click nút ẩn/hiện phản hồi
        $(document).on('click', '.toggle-reply', function () {
            var button = $(this);
            var target = $(button.data('target'));

            // Kiểm tra trạng thái hiện tại
            if (target.hasClass('show')) {
                // Đang hiện, chuyển sang ẩn
                button.html('<i class="fas fa-chevron-up"></i>');
            } else {
                // Đang ẩn, chuyển sang hiện
                button.html('<i class="fas fa-chevron-down"></i>');
            }
        });

        // Thêm hiệu ứng hover cho hàng đánh giá
        $(document).on('mouseenter', 'tr:not(.seller-reply-row)', function () {
            var reviewId = $(this).find('button[data-review-id]').data('review-id');
            if (reviewId) {
                $(this).next('tr.seller-reply-row').addClass('hover-highlight');
            }
        }).on('mouseleave', 'tr:not(.seller-reply-row)', function () {
            $(this).next('tr.seller-reply-row').removeClass('hover-highlight');
        });
    });

    // Xử lý khi thay đổi bộ lọc
    function applyFilter() {
        var ratingFilter = $('#ratingFilter').val();
        var sortOrder = $('#sortOrder').val();

        // Cập nhật giá trị hidden inputs
        $('#hiddenStatusFilter').val(ratingFilter);
        $('#hiddenSortOrder').val(sortOrder);

        // Submit form
        $('#searchForm').submit();
    }
    </script>
}