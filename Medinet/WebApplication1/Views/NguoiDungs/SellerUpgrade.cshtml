@model WebApplication1.Models.NguoiBan

@{
    ViewBag.Title = "Đăng ký người bán";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* CSS cho tabs chưa active */
    .nav-tabs .nav-link {
        color: #6c757d; /* Màu xám cho các tab chưa được chọn */
        background-color: transparent;
        border-bottom: 2px solid transparent;
        transition: all 0.3s ease;
    }

        /* CSS cho tab đang active */
        .nav-tabs .nav-link.active {
            color: #0d6efd; /* Màu xanh cho tab đang active */
            background-color: transparent;
            border-bottom: 2px solid #0d6efd;
            font-weight: 500;
        }

        /* Hover effect */
        .nav-tabs .nav-link:hover:not(.active) {
            color: #0d6efd;
            border-bottom: 2px solid #e9ecef;
        }

    /* CSS cho sidebar item active */
    .list-group-item.active-account {
        color: #0d6efd !important;
        background-color: rgba(13, 110, 253, 0.1);
        font-weight: 500;
    }

    /* Form styling */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-control {
        height: calc(2.5rem);
        padding: 0.75rem 1rem;
    }

    textarea.form-control {
        height: auto;
    }

    .col-form-label {
        font-weight: 500;
        color: #495057;
    }

    .form-group h6 {
        color: #495057;
        font-weight: 600;
    }

    .form-section {
        margin-top: 2.5rem;
        padding-top: 1rem;
        border-top: 1px solid #eee;
    }

    .card-body {
        padding: 2rem;
    }

    /* Styles for certificates */
    .certificate-container {
        border: 1px dashed #ddd;
        padding: 1.5rem;
        border-radius: 0.5rem;
        background-color: #f9f9f9;
    }

    .certificate-item {
        transition: all 0.3s ease;
    }

        .certificate-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }

    .feature-icon {
        background-color: #f8f9fa;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
    }

        .feature-icon i {
            font-size: 1.5rem;
            color: #007bff;
        }

    /* Step form styles */
    .form-step {
        display: none;
    }

        .form-step.active {
            display: block;
        }

    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        position: relative;
    }

        .step-indicator:before {
            content: "";
            position: absolute;
            top: 1.5rem;
            left: 0;
            right: 0;
            height: 2px;
            background: #e9ecef;
            z-index: 1;
        }

    .step {
        position: relative;
        z-index: 2;
        text-align: center;
        width: 32%;
    }

    .step-number {
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        background-color: #e9ecef;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .step.active .step-number {
        background-color: #0d6efd;
        color: white;
    }

    .step.completed .step-number {
        background-color: #28a745;
        color: white;
    }

    .step-text {
        font-size: 0.9rem;
        color: #6c757d;
        transition: all 0.3s ease;
    }

    .step.active .step-text,
    .step.completed .step-text {
        color: #212529;
        font-weight: 500;
    }

    .form-navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e9ecef;
    }
</style>

<div class="container mt-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-body text-center">
                    <img src="@(string.IsNullOrEmpty(ViewBag.AnhDaiDien) ? "~/Content/Images/default-avatar.png" : Url.Content(ViewBag.AnhDaiDien))" alt="Ảnh đại diện" class="rounded-circle mb-3" style="width: 120px; height: 120px; object-fit: cover;">
                    <h5 class="mb-0">@ViewBag.TenNguoiDung</h5>
                    <p class="text-muted"><a href="@Url.Action("Profile", "NguoiDungs")" class="text-decoration-none"><img src="~/Content/Images/edit-icon.png" width="16" height="16" class="me-1">Sửa thông tin</a></p>
                </div>
            </div>

            <div class="list-group mb-4">
                @{
                    var accountActions = new[] { "Profile", "Addresses", "SellerUpgrade", "ChangePassword", "DeleteAccount" };
                    var isAccountActive = accountActions.Contains(ViewContext.RouteData.Values["Action"].ToString());
                }
                <a href="@Url.Action("Profile", "NguoiDungs")" class="list-group-item list-group-item-action d-flex align-items-center @(isAccountActive ? "active-account" : "")">
                    <i class="fas fa-user me-3"></i>Tài khoản của tôi
                </a>
                <a href="@Url.Action("Index", "ThongBao")" class="list-group-item list-group-item-action d-flex align-items-center">
                    <i class="fas fa-bell me-3"></i>Thông báo
                </a>
                <a href="@Url.Action("DonHangCuaToi", "DonHang")" class="list-group-item list-group-item-action d-flex align-items-center">
                    <i class="fas fa-shopping-bag me-3"></i>Đơn mua
                </a>
                <a href="@Url.Action("DangXuat", "DangNhap")" class="list-group-item list-group-item-action d-flex align-items-center text-danger">
                    <i class="fas fa-sign-out-alt me-3"></i>Đăng xuất
                </a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
            <div class="card shadow-sm">
                <div class="card-header bg-white p-0">
                    <ul class="nav nav-tabs">
                        <li class="nav-item">
                            <a class="nav-link px-4 @(ViewContext.RouteData.Values["Action"].ToString() == "Profile" ? "active" : "")" href="@Url.Action("Profile", "NguoiDungs")">Hồ sơ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link px-4 @(ViewContext.RouteData.Values["Action"].ToString() == "SellerUpgrade" ? "active" : "")" href="@Url.Action("SellerUpgrade", "NguoiDungs")">Nâng cấp tài khoản</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link px-4 @(ViewContext.RouteData.Values["Action"].ToString() == "ChangePassword" ? "active" : "")" href="@Url.Action("ChangePassword", "NguoiDungs")">Đổi mật khẩu</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link px-4 @(ViewContext.RouteData.Values["Action"].ToString() == "DeleteAccount" ? "active" : "")" href="@Url.Action("DeleteAccount", "NguoiDungs")">Xóa tài khoản</a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    @if (ViewBag.SuccessMessage != null)
                    {
                        <div class="alert alert-success">
                            @ViewBag.SuccessMessage
                        </div>
                    }

                    @if (ViewBag.BiTuChoiNangCap == true)
                    {
                        <div class="alert alert-danger">
                            <h5><i class="fas fa-exclamation-circle mr-2"></i>Yêu cầu nâng cấp đã bị từ chối</h5>
                            <p>Yêu cầu nâng cấp thành người bán của bạn đã bị từ chối vào @(((DateTime)ViewBag.NgayTuChoiNangCap).ToString("HH:mm dd/MM/yyyy")).</p>
                            <p>Vui lòng cập nhật đầy đủ thông tin và đăng ký lại.</p>
                            <a href="@Url.Action("ReRegisterSeller", "NguoiDungs")" class="btn btn-primary">
                                <i class="fas fa-redo mr-1"></i> Đăng ký lại
                            </a>
                        </div>
                    }
                    else
                    {
                        if (Model != null && Model.MaNguoiBan > 0)
                        {
                            <div class="alert alert-info">
                                <h5><i class="fas fa-info-circle mr-2"></i>Thông tin người bán</h5>
                                <p>Bạn đã đăng ký làm người bán. Hãy cập nhật thông tin cửa hàng và chứng chỉ để tạo niềm tin với khách hàng.</p>
                                @{
                                    var vaitro = Session["VaiTro"];
                                    switch (vaitro)
                                    {
                                        case "Seller":
                                            <a href="@Url.Action("EditSellerProfile", "NguoiDungs")" class="btn btn-primary">
                                                <i class="fas fa-store mr-1"></i> Đến trang người bán
                                            </a>
                                            break;
                                        default:
                                            <div class="alert alert-warning mt-2" role="alert">
                                                <i class="fas fa-exclamation-triangle mr-2"></i> Yêu cầu của bạn đang chờ Admin duyệt. Vui lòng kiểm tra lại sau.
                                            </div>
                                            <a href="#" class="btn btn-primary">
                                                <i class="fas fa-store mr-1"></i> Đến trang người bán
                                            </a>
                                            break;
                                    }
                                }

                                <!-- Thêm hidden field để lưu MaNguoiBan khi đã có người bán -->
                                <input type="hidden" id="MaNguoiBan" value="@Model.MaNguoiBan" />
                            </div>
                        }
                        else
                        {
                            <!-- Đặt hidden field với giá trị 0 cho trường hợp chưa đăng ký người bán -->
                            <input type="hidden" id="MaNguoiBan" value="0" />

                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <div class="alert alert-primary">
                                        <h5><i class="fas fa-lightbulb mr-2"></i>Lợi ích khi trở thành người bán</h5>
                                        <div class="row mt-3">
                                            <div class="col-md-4 text-center mb-3">
                                                <div class="feature-icon mx-auto">
                                                    <i class="fas fa-globe"></i>
                                                </div>
                                                <h6>Tiếp cận khách hàng</h6>
                                                <p class="small">Mở rộng phạm vi bán hàng trên nền tảng của chúng tôi</p>
                                            </div>
                                            <div class="col-md-4 text-center mb-3">
                                                <div class="feature-icon mx-auto">
                                                    <i class="fas fa-chart-line"></i>
                                                </div>
                                                <h6>Phân tích dữ liệu</h6>
                                                <p class="small">Theo dõi và tối ưu hiệu suất bán hàng</p>
                                            </div>
                                            <div class="col-md-4 text-center mb-3">
                                                <div class="feature-icon mx-auto">
                                                    <i class="fas fa-hand-holding-usd"></i>
                                                </div>
                                                <h6>Thanh toán đơn giản</h6>
                                                <p class="small">Nhận tiền nhanh chóng và an toàn</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Indicators for steps -->
                            <div class="step-indicator mb-4">
                                <div class="step active" id="step1-indicator">
                                    <div class="step-number">1</div>
                                    <div class="step-text">Thông tin cửa hàng</div>
                                </div>
                                <div class="step" id="step2-indicator">
                                    <div class="step-number">2</div>
                                    <div class="step-text">Chứng chỉ & xác thực</div>
                                </div>
                                <div class="step" id="step3-indicator">
                                    <div class="step-number">3</div>
                                    <div class="step-text">Xác nhận</div>
                                </div>
                            </div>

                            using (Html.BeginForm("SellerUpgrade", "NguoiDungs", FormMethod.Post, new { id = "sellerForm" }))
                            {
                                @Html.AntiForgeryToken()
                                @Html.ValidationSummary(true, "", new { @class = "text-danger" })

                                <!-- STEP 1: Thông tin cửa hàng -->
                                <div class="form-step active" id="step1">
                                    <div class="row mt-4">
                                        <div class="col-md-12">
                                            <h5 class="border-bottom pb-2 mb-4">Thông tin cửa hàng</h5>
                                        </div>
                                    </div>

                                    <div class="form-group row">
                                        <label class="col-sm-3 col-form-label">Tên cửa hàng</label>
                                        <div class="col-sm-9">
                                            @Html.TextBoxFor(model => model.TenCuaHang, new { @class = "form-control", placeholder = "Tên cửa hàng" })
                                            @Html.ValidationMessageFor(model => model.TenCuaHang, "", new { @class = "text-danger" })
                                        </div>
                                    </div>

                                    <div class="form-group row">
                                        <label class="col-sm-3 col-form-label">Số điện thoại cửa hàng</label>
                                        <div class="col-sm-9">
                                            @Html.TextBoxFor(model => model.SoDienThoaiCuaHang, new { @class = "form-control", placeholder = "Số điện thoại phải có 10 chữ số", maxlength = "10", pattern = "[0-9]{10}", title = "Số điện thoại phải có 10 chữ số" })
                                            @Html.ValidationMessageFor(model => model.SoDienThoaiCuaHang, "", new { @class = "text-danger" })
                                        </div>
                                    </div>

                                    <div class="form-group row">
                                        <label class="col-sm-3 col-form-label">Địa chỉ cửa hàng</label>
                                        <div class="col-sm-9">
                                            @Html.TextBoxFor(model => model.DiaChiCuaHang, new { @class = "form-control", placeholder = "Địa chỉ cửa hàng" })
                                            @Html.ValidationMessageFor(model => model.DiaChiCuaHang, "", new { @class = "text-danger" })
                                        </div>
                                    </div>

                                    <div class="form-group row">
                                        <label class="col-sm-3 col-form-label">Mô tả cửa hàng</label>
                                        <div class="col-sm-9">
                                            @Html.TextAreaFor(model => model.MoTaCuaHang, new { @class = "form-control", rows = 4, placeholder = "Mô tả về cửa hàng của bạn" })
                                            @Html.ValidationMessageFor(model => model.MoTaCuaHang, "", new { @class = "text-danger" })
                                        </div>
                                    </div>

                                    <div class="form-navigation">
                                        <div></div>
                                        <button type="button" class="btn btn-primary next-step">Tiếp tục <i class="fas fa-arrow-right ml-2"></i></button>
                                    </div>
                                </div>

                                <!-- STEP 2: Chứng chỉ & xác thực -->
                                <div class="form-step" id="step2">
                                    <div class="row mt-4">
                                        <div class="col-md-12">
                                            <h5 class="border-bottom pb-2 mb-4">Chứng chỉ & xác thực</h5>
                                            <p class="text-muted">Thêm chứng chỉ để tăng uy tín cho cửa hàng của bạn.</p>
                                        </div>
                                    </div>

                                    <!-- Phần HTML mới cho khung chứng chỉ -->
                                    <div class="mt-4 p-4 bg-light rounded">
                                        <div class="text-center mb-3">
                                            <i class="fas fa-certificate fa-3x text-primary mb-3"></i>
                                            <h5>Chứng chỉ & xác thực</h5>
                                            <p class="text-muted">
                                                Bạn có thể tải lên tối đa 5 chứng chỉ để xác thực cửa hàng của bạn. Các chứng chỉ này
                                                giúp khách hàng tin tưởng vào chất lượng sản phẩm và dịch vụ của bạn.
                                            </p>
                                        </div>

                                        <div class="row mb-4">
                                            <div class="col-md-4">
                                                <div class="card bg-light mb-3">
                                                    <div class="card-body text-center">
                                                        <i class="fas fa-award text-warning mb-2"></i>
                                                        <h6>Chứng chỉ chất lượng</h6>
                                                        <p class="small">ISO, HACCP, ...</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card bg-light mb-3">
                                                    <div class="card-body text-center">
                                                        <i class="fas fa-medal text-success mb-2"></i>
                                                        <h6>Giấy phép kinh doanh</h6>
                                                        <p class="small">Giấy tờ pháp lý</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card bg-light mb-3">
                                                    <div class="card-body text-center">
                                                        <i class="fas fa-crown text-primary mb-2"></i>
                                                        <h6>Giải thưởng</h6>
                                                        <p class="small">Thành tựu đạt được</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Form upload chứng chỉ mới -->
                                        <div class="mt-4 p-3 bg-white rounded border">
                                            <h6 class="mb-3">Tải lên chứng chỉ của bạn</h6>
                                            <div class="custom-file mb-3">
                                                <input type="file" class="custom-file-input" id="certificateFiles" name="AnhChungChi" multiple accept="image/*">
                                                <label class="custom-file-label" for="certificateFiles">Chọn ảnh chứng chỉ...</label>
                                            </div>
                                            <small class="form-text text-muted mt-2">
                                                <ul class="ps-3 mb-0">
                                                    <li>Dung lượng tối đa: 2MB mỗi ảnh</li>
                                                    <li>Định dạng hỗ trợ: JPG, PNG</li>
                                                    <li>Vui lòng đặt tên file là tên chứng chỉ</li>
                                                    <li>File sẽ tự động được tải lên sau khi chọn</li>
                                                </ul>
                                            </small>
                                        </div>

                                        <!-- Container hiển thị chứng chỉ -->
                                        <div id="certificates-container" class="row mt-3">
                                            <!-- Chứng chỉ sẽ được thêm vào đây qua JavaScript -->
                                            <div class="col-12 text-center py-4 no-certificates">
                                                <p class="text-muted">Chưa có chứng chỉ nào. Hãy thêm chứng chỉ để tạo niềm tin với khách hàng!</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-navigation">
                                        <button type="button" class="btn btn-secondary prev-step"><i class="fas fa-arrow-left mr-2"></i> Quay lại</button>
                                        <button type="button" class="btn btn-primary next-step">Tiếp tục <i class="fas fa-arrow-right ml-2"></i></button>
                                    </div>
                                </div>

                                <!-- STEP 3: Xác nhận -->
                                <div class="form-step" id="step3">
                                    <div class="row mt-4">
                                        <div class="col-md-12">
                                            <h5 class="border-bottom pb-2 mb-4">Xác nhận thông tin</h5>
                                            <p>Vui lòng kiểm tra lại thông tin trước khi đăng ký.</p>
                                        </div>
                                    </div>

                                    <div class="bg-light p-4 rounded">
                                        <h6 class="mb-3">Thông tin cửa hàng</h6>
                                        <div class="row mb-3">
                                            <div class="col-sm-4 text-muted">Tên cửa hàng:</div>
                                            <div class="col-sm-8 font-weight-medium" id="summary-store-name"></div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-sm-4 text-muted">Số điện thoại:</div>
                                            <div class="col-sm-8 font-weight-medium" id="summary-store-phone"></div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-sm-4 text-muted">Địa chỉ:</div>
                                            <div class="col-sm-8 font-weight-medium" id="summary-store-address"></div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-sm-4 text-muted">Mô tả:</div>
                                            <div class="col-sm-8" id="summary-store-description"></div>
                                        </div>

                                        <h6 class="mb-3 mt-4">Chứng chỉ & xác thực</h6>
                                        <div id="summary-certificates" class="row">
                                            <div class="col-12 text-muted">
                                                <p id="no-certificates-message">Chưa có chứng chỉ nào được tải lên.</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group row mt-4">
                                        <div class="col-sm-12 text-center">
                                            <div class="form-check d-flex align-items-center justify-content-center mb-3">
                                                <input class="form-check-input mr-2" style="margin-right: 5px; position: relative; top: 0px;" type="checkbox" required id="acceptTerms">
                                                <label class="form-check-label" for="acceptTerms">
                                                    Tôi đồng ý với <a href="#" data-toggle="modal" data-target="#termsModal">điều khoản & điều kiện</a> khi trở thành người bán
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-navigation">
                                        <button type="button" class="btn btn-secondary prev-step"><i class="fas fa-arrow-left mr-2"></i> Quay lại</button>
                                        <button type="submit" class="btn btn-primary btn-lg px-5">
                                            <i class="fas fa-store mr-2"></i> Đăng ký người bán
                                        </button>
                                    </div>
                                </div>
                            }
                        }
                    }

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Điều khoản -->
<div class="modal fade" id="termsModal" tabindex="-1" role="dialog" aria-labelledby="termsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="termsModalLabel">Điều khoản & Điều kiện dành cho người bán</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h6>1. Quy định chung</h6>
                <p>Người bán có trách nhiệm cung cấp thông tin chính xác về sản phẩm, giá cả và dịch vụ.</p>

                <h6>2. Nghĩa vụ thanh toán</h6>
                <p>Người bán đồng ý thanh toán phí dịch vụ theo quy định của nền tảng.</p>

                <h6>3. Cấp phép và chứng chỉ</h6>
                <p>Người bán có trách nhiệm duy trì các giấy phép và chứng chỉ cần thiết cho hoạt động kinh doanh.</p>

                <h6>4. Vận chuyển và giao hàng</h6>
                <p>Người bán phải đảm bảo giao hàng đúng thời hạn và trong tình trạng tốt.</p>

                <h6>5. Hình ảnh và nội dung</h6>
                <p>Tất cả hình ảnh và nội dung sử dụng phải tuân thủ bản quyền và không vi phạm quyền sở hữu trí tuệ.</p>

                <h6>6. Chính sách hoàn trả</h6>
                <p>Người bán phải có chính sách hoàn trả rõ ràng và công bằng.</p>

                <h6>7. Bảo mật thông tin</h6>
                <p>Người bán phải bảo vệ thông tin cá nhân của khách hàng và không được sử dụng cho mục đích khác.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Tôi đồng ý</button>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        $(document).ready(function () {
    // Xử lý khi người dùng click vào nút "Tôi đồng ý" trong modal
    $('#termsModal .btn-primary').on('click', function() {
        $('#acceptTerms').prop('checked', true);
    });

    // Hiện console log để debug
    console.log("SellerUpgrade script loaded");

    // ===== XỬ LÝ FORM THEO BƯỚC =====
    // Xử lý nút "Tiếp tục"
    $('.next-step').on('click', function() {
        var currentStep = $(this).closest('.form-step');
        var currentStepId = currentStep.attr('id');

        // Nếu đang ở bước 1 và chuẩn bị qua bước 2
        if (currentStepId === 'step1') {
            // Kiểm tra dữ liệu nhập vào
            var isValid = validateStep1();
            if (!isValid) return;

            // Lấy thông tin từ form
            var tenCuaHang = $('#TenCuaHang').val();
            var soDienThoai = $('#SoDienThoaiCuaHang').val();
            var diaChi = $('#DiaChiCuaHang').val();
            var moTa = $('#MoTaCuaHang').val();
            var maNguoiBan = $('#MaNguoiBan').val() || 0;

            // Hiển thị thông báo đang xử lý
            var $loadingMsg = $('<div class="alert alert-info mt-2 loading-message"><i class="fas fa-spinner fa-spin mr-2"></i> Đang xử lý...</div>');
            currentStep.find('.form-navigation').before($loadingMsg);

            // Gửi request tạo/cập nhật NguoiBan
            $.ajax({
                url: '@Url.Action("SellerUpgrade", "NguoiDungs")',
                type: 'POST',
                data: {
                    MaNguoiBan: maNguoiBan,
                    TenCuaHang: tenCuaHang,
                    SoDienThoaiCuaHang: soDienThoai,
                    DiaChiCuaHang: diaChi,
                    MoTaCuaHang: moTa,
                    isAjax: true,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        // Cập nhật MaNguoiBan
                        $('#MaNguoiBan').val(response.maNguoiBan);
                        console.log("Seller profile created/updated successfully. MaNguoiBan:", response.maNguoiBan);

                        // Chuyển sang bước tiếp theo
                        goToNextStep(currentStep);

                        // Cập nhật thông tin tóm tắt ở bước 3
                        updateSummary();
                    } else {
                        // Hiển thị lỗi
                        alert('Lỗi: ' + response.message);
                        $loadingMsg.remove();
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error creating seller profile:", error);
                    var errorMessage = "Đã xảy ra lỗi khi lưu thông tin cửa hàng. Vui lòng thử lại sau.";

                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }

                    alert(errorMessage);
                    $loadingMsg.remove();
                },
                complete: function() {
                    // Xóa thông báo loading
                    $loadingMsg.remove();
                }
            });
        } else {
            // Nếu không phải bước 1, xử lý chuyển bước bình thường
            goToNextStep(currentStep);
        }
    });

    // Xử lý nút "Quay lại"
    $('.prev-step').on('click', function() {
        var currentStep = $(this).closest('.form-step');
        var prevStep = currentStep.prev('.form-step');
        var currentStepId = currentStep.attr('id');
        var prevStepId = prevStep.attr('id');

        // Chuyển về bước trước
        currentStep.removeClass('active');
        prevStep.addClass('active');

        // Cập nhật chỉ báo bước
        $('#' + currentStepId + '-indicator').removeClass('active');
        $('#' + prevStepId + '-indicator').removeClass('completed').addClass('active');

        // Cuộn lên đầu form
        $('html, body').animate({
            scrollTop: $('.step-indicator').offset().top - 100
        }, 500);
    });

    // Validate dữ liệu bước 1
    function validateStep1() {
        var isValid = true;

        // Kiểm tra tên cửa hàng
        if ($('#TenCuaHang').val().trim() === '') {
            $('#TenCuaHang').next('.text-danger').text('Vui lòng nhập tên cửa hàng');
            isValid = false;
        } else {
            $('#TenCuaHang').next('.text-danger').text('');
        }

        // Kiểm tra số điện thoại
        var phonePattern = /^[0-9]{10}$/;
        var phone = $('#SoDienThoaiCuaHang').val().trim();
        if (phone === '') {
            $('#SoDienThoaiCuaHang').next('.text-danger').text('Vui lòng nhập số điện thoại cửa hàng');
            isValid = false;
        } else if (!phonePattern.test(phone)) {
            $('#SoDienThoaiCuaHang').next('.text-danger').text('Số điện thoại phải có 10 chữ số');
            isValid = false;
        } else {
            $('#SoDienThoaiCuaHang').next('.text-danger').text('');
        }

        // Kiểm tra địa chỉ
        if ($('#DiaChiCuaHang').val().trim() === '') {
            $('#DiaChiCuaHang').next('.text-danger').text('Vui lòng nhập địa chỉ cửa hàng');
            isValid = false;
        } else {
            $('#DiaChiCuaHang').next('.text-danger').text('');
        }

        // Kiểm tra mô tả
        if ($('#MoTaCuaHang').val().trim() === '') {
            $('#MoTaCuaHang').next('.text-danger').text('Vui lòng nhập mô tả cửa hàng');
            isValid = false;
        } else {
            $('#MoTaCuaHang').next('.text-danger').text('');
        }

        if (!isValid) {
            $('html, body').animate({
                scrollTop: $('.text-danger:visible').first().offset().top - 100
            }, 500);
        }

        return isValid;
    }

    // Hàm chuyển sang bước tiếp theo
    function goToNextStep(currentStep) {
        var nextStep = currentStep.next('.form-step');
        var currentStepId = currentStep.attr('id');
        var nextStepId = nextStep.attr('id');

        // Chuyển sang bước tiếp theo
        currentStep.removeClass('active');
        nextStep.addClass('active');

        // Cập nhật chỉ báo bước
        $('#' + currentStepId + '-indicator').addClass('completed');
        $('#' + nextStepId + '-indicator').addClass('active');

        // Cuộn lên đầu form
        $('html, body').animate({
            scrollTop: $('.step-indicator').offset().top - 100
        }, 500);
    }

    // Cập nhật thông tin tóm tắt ở bước 3
    function updateSummary() {
        $('#summary-store-name').text($('#TenCuaHang').val());
        $('#summary-store-phone').text($('#SoDienThoaiCuaHang').val());
        $('#summary-store-address').text($('#DiaChiCuaHang').val());
        $('#summary-store-description').text($('#MoTaCuaHang').val());

        // Cập nhật thông tin chứng chỉ
        updateCertificatesSummary();
    }

    // Cập nhật phần tóm tắt chứng chỉ
    function updateCertificatesSummary() {
        if ($('.certificate-item').length > 0) {
            $('#no-certificates-message').hide();
            $('#summary-certificates').empty();

            $('.certificate-item').each(function() {
                var certId = $(this).data('id');
                var certName = $(this).find('.card-text.small.mb-1').text();
                var certImage = $(this).find('img').attr('src');

                var certHtml = `
                    <div class="col-md-3 mb-3">
                        <div class="card">
                            <img src="${certImage}" class="card-img-top" style="height: 100px; object-fit: cover;">
                            <div class="card-body p-2">
                                <p class="small mb-0">${certName}</p>
                            </div>
                        </div>
                    </div>
                `;

                $('#summary-certificates').append(certHtml);
            });
        } else {
            $('#no-certificates-message').show();
        }
    }

    // Tự động tải lên khi chọn file
    $('#certificateFiles').on('change', function() {
        var fileInput = $(this)[0];
        var files = fileInput.files;
        var fileCount = files.length;

        if (fileCount === 0) {
            return;
        }

        console.log("Files selected:", fileCount);

        // Kiểm tra số lượng file
        if (fileCount > 5) {
            alert('Bạn chỉ có thể tải lên tối đa 5 chứng chỉ cùng một lúc.');
            $(this).val('');
            return;
        }

        // Kiểm tra tổng số chứng chỉ (hiện có + mới)
        var currentCount = $('.certificate-item').length;
        if (currentCount + fileCount > 5) {
            alert('Tổng số chứng chỉ không thể vượt quá 5. Bạn có thể tải lên thêm ' + (5 - currentCount) + ' chứng chỉ.');
            $(this).val('');
            return;
        }

        // Hiển thị tên file đã chọn
        var label = fileCount > 1 ? fileCount + ' file đã chọn' : $(this).val().split('\\').pop();
        $(this).next('.custom-file-label').html(label);

        // Lấy MaNguoiBan từ hidden field
        var maNguoiBan = $('#MaNguoiBan').val();

        // Kiểm tra xem đã có MaNguoiBan chưa
        if (!maNguoiBan || maNguoiBan <= 0) {
            alert('Vui lòng điền thông tin cửa hàng ở bước 1 trước khi tải lên chứng chỉ.');
            $(this).val('');
            return;
        }

        // Tạo FormData object
        var formData = new FormData();

        // Thêm token chống giả mạo
        formData.append("__RequestVerificationToken", $('input[name="__RequestVerificationToken"]').val());

        // Thêm MaNguoiBan vào form data
        formData.append("MaNguoiBan", maNguoiBan);

        // Thêm các file đã chọn
        for (var i = 0; i < fileCount; i++) {
            // Kiểm tra kích thước file (2MB = 2 * 1024 * 1024)
            if (fileInput.files[i].size > 2 * 1024 * 1024) {
                alert('Lỗi: File ' + fileInput.files[i].name + ' vượt quá 2MB');
                return;
            }

            // Kiểm tra định dạng file
            var fileName = fileInput.files[i].name.toLowerCase();
            if (!fileName.endsWith('.jpg') && !fileName.endsWith('.jpeg') && !fileName.endsWith('.png')) {
                alert('Lỗi: File ' + fileInput.files[i].name + ' không đúng định dạng (chỉ hỗ trợ JPG, JPEG, PNG)');
                return;
            }

            formData.append("AnhChungChi", files[i]);
            console.log("Added file:", files[i].name, "size:", files[i].size);
        }

        // Hiển thị thông báo đang tải
        var $loadingMsg = $('<div class="mt-2 text-primary uploading-message"><i class="fas fa-spinner fa-spin"></i> Đang tải lên chứng chỉ...</div>');
        $('.custom-file').after($loadingMsg);

        // Log URL action để debug
        var uploadUrl = '@Url.Action("UploadCertificates", "NguoiDungs")';
        console.log("Uploading to URL:", uploadUrl);

        // Gửi AJAX request
        $.ajax({
            url: uploadUrl,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            timeout: 60000, // Tăng timeout lên 60 giây
            success: function(response) {
                console.log("Upload success response:", response);
                if (response.success) {
                    // Xóa thông báo "không có chứng chỉ" nếu có
                    $('.no-certificates').remove();

                    // Thêm chứng chỉ mới vào UI
                    $.each(response.certificates, function(index, cert) {
                        var certificateHtml = `
                            <div class="col-md-3 mb-4 certificate-item" data-id="${cert.Id}">
                                <div class="card shadow-sm">
                                    <img src="${cert.Anh}" class="card-img-top" alt="${cert.Ten}" style="height: 160px; object-fit: cover;">
                                    <div class="card-body p-3">
                                        <p class="card-text small mb-1 font-weight-bold">${cert.Ten}</p>
                                        <p class="card-text small text-muted mb-2">Ngày cập nhật: ${cert.Ngay}</p>
                                        <button type="button" class="btn btn-sm btn-outline-danger btn-block delete-certificate" data-id="${cert.Id}">
                                            <i class="fas fa-times mr-1"></i> Xóa
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        $('#certificates-container').append(certificateHtml);
                    });

                    // Reset form
                    fileInput.value = '';
                    $('.custom-file-label').html('Chọn ảnh chứng chỉ...');

                    // Hiển thị thông báo thành công
                    var $successMsg = $('<div class="alert alert-success mt-2">Tải lên chứng chỉ thành công!</div>');
                    $('.custom-file').after($successMsg);
                    setTimeout(function() {
                        $successMsg.fadeOut(function() {
                            $(this).remove();
                        });
                    }, 3000);

                    // Cập nhật thông tin tóm tắt ở bước 3
                    updateCertificatesSummary();
                } else {
                    console.error("Upload failed:", response.message);
                    alert('Lỗi: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                // Log chi tiết lỗi để debug
                console.error("Ajax Error Details:");
                console.error("Status:", status);
                console.error("Error:", error);
                console.error("Status code:", xhr.status);
                console.error("Response Text:", xhr.responseText);

                // Xử lý lỗi kết nối
                var errorMessage = "Không thể kết nối đến máy chủ. Vui lòng thử lại sau.";
                if (status === "timeout") {
                    errorMessage = "Quá thời gian chờ kết nối. Vui lòng thử lại sau.";
                } else if (xhr.status === 0) {
                    errorMessage = "Không thể kết nối đến máy chủ. Vui lòng kiểm tra kết nối internet của bạn.";
                } else if (xhr.status === 404) {
                    errorMessage = "Không tìm thấy trang yêu cầu (404). Vui lòng liên hệ quản trị viên.";
                } else if (xhr.status === 500) {
                    errorMessage = "Lỗi máy chủ (500). Đã xảy ra lỗi khi xử lý yêu cầu. Vui lòng thử lại sau hoặc liên hệ quản trị viên.";
                    // Thử hiển thị chi tiết lỗi từ server nếu có
                    if (xhr.responseText) {
                        try {
                            var response = JSON.parse(xhr.responseText);
                            if (response.message) {
                                errorMessage += "\n\nChi tiết lỗi: " + response.message;
                            }
                        } catch(e) {
                            // JSON không hợp lệ, bỏ qua
                        }
                    }
                }

                alert(errorMessage);
            },
            complete: function() {
                console.log("Ajax request completed");
                // Xóa thông báo đang tải
                $loadingMsg.remove();
            }
        });
    });

    // Xử lý nút xóa chứng chỉ
    $(document).on('click', '.delete-certificate', function(e) {
        e.preventDefault();

        var $btn = $(this);
        var certificateId = $btn.data('id');
        console.log("Deleting certificate with ID:", certificateId);

        if (confirm('Bạn có chắc chắn muốn xóa chứng chỉ này?')) {
            $.ajax({
                url: '@Url.Action("DeleteCertificate", "NguoiDungs")',
                type: 'POST',
                data: { id: certificateId },
                success: function(result) {
                    console.log("Delete certificate response:", result);
                    if (result.success) {
                        // Xóa phần tử UI
                        $btn.closest('.certificate-item').fadeOut(function() {
                            $(this).remove();

                            // Kiểm tra nếu không còn chứng chỉ nào
                            if ($('.certificate-item').length === 0) {
                                $('#certificates-container').html(
                                    '<div class="col-12 text-center py-4 no-certificates">' +
                                    '<p class="text-muted">Chưa có chứng chỉ nào. Hãy thêm chứng chỉ để tạo niềm tin với khách hàng!</p>' +
                                    '</div>'
                                );
                            }

                            // Cập nhật thông tin tóm tắt ở bước 3
                            updateCertificatesSummary();
                        });
                    } else {
                        alert(result.message || 'Có lỗi xảy ra khi xóa chứng chỉ.');
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error deleting certificate:", status, error);
                    alert('Không thể kết nối đến máy chủ. Vui lòng thử lại sau.');
                }
            });
        }
    });

    // Xử lý form submit
    $('#sellerForm').on('submit', function(e) {
        // Kiểm tra xem đã có MaNguoiBan chưa
        var maNguoiBan = $('#MaNguoiBan').val();
        if (!maNguoiBan || maNguoiBan <= 0) {
            alert('Vui lòng hoàn thành các bước trước khi đăng ký.');
            e.preventDefault();
            return false;
        }

        // Kiểm tra đã chọn đồng ý điều khoản chưa
        if (!$('#acceptTerms').is(':checked')) {
            alert('Vui lòng đồng ý với điều khoản và điều kiện để tiếp tục.');
            e.preventDefault();
            return false;
        }

        // Đảm bảo gửi MaNguoiBan với form
        if ($('#MaNguoiBan').length === 0) {
            $('<input>').attr({
                type: 'hidden',
                name: 'MaNguoiBan',
                value: maNguoiBan
            }).appendTo($(this));
        }

        // Hiển thị thông báo đang xử lý
        var submitBtn = $(this).find('button[type="submit"]');
        submitBtn.prop('disabled', true);
        submitBtn.html('<i class="fas fa-spinner fa-spin mr-1"></i> Đang xử lý...');
    });

    // Focus vào trường input khi có lỗi
    $('.form-control').on('focus', function() {
        $(this).next('.text-danger').text('');
    });
});
    </script>
}